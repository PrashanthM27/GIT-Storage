global class FCST_CopyLineInitials implements Database.Batchable<sObject>,Database.stateful{
    global Set<Id> setFailedAccounts = new Set<Id>();
    global String Query;
    map<Id,Id> mapVersionChange;
    global FCST_CopyLineInitials(map<Id,Id> mv){
        mapVersionChange = mv;
        set<Id> setVersions = new set<Id>();
     
        Query = 'select Id,Account__c,Contract_LineItem__c,Fcst_Amount__c,FCST_Contract__c,FCST_Fiscal_Year_List__c,';
        Query += 'FCST_Planning_Fiscal_Year__c,Planning_Version__c,Planning_Version__r.name,name,Risk_Factor__c from FCST_Initial_Forecast__c where Planning_Version__c IN: setVersions';
       
    }

    global Database.QueryLocator start(Database.BatchableContext BC){
     
        set<Id> setVersions = new set<Id>();
        setVersions = mapVersionChange.keyset();
        return Database.getQueryLocator(query);
    }
      
    global void execute(Database.BatchableContext BC, List<FCST_Initial_Forecast__c> scope){
        if(scope.size()>0){
    
            map<Id,Planning_Version__c> mapVersionChangev2 = new map<Id,Planning_Version__c>();
            set<Id> setModelVersion = new set<Id>();
            for(FCST_Initial_Forecast__c m: scope){
                setModelVersion.add(m.Planning_Version__c);
            }
            for(Planning_Version__c v : [select Id,Name,Previous_Version__c,Data_Entry_Closed_Date__c from Planning_Version__c where  Previous_Version__c IN: setModelVersion]){
                mapVersionChangev2.put(v.Previous_Version__c,v);
            }
            
            string cYear = string.valueOf(system.today().Year());            
            
            List<FCST_Initial_Forecast__c > lstModels = new List<FCST_Initial_Forecast__c >();
            List<FCST_Initial_Forecast__c > lstProcessModels = new List<FCST_Initial_Forecast__c >();
            
            set<string> processKeys = new set<string>();
            
            
            set<Id> setOppIds = new set<Id>();
           
            
            for(FCST_Initial_Forecast__c m :scope){
                
                       
                        Id newVersion = mapVersionChangev2.get(m.Planning_Version__c).id;
                           
                        string Key = LEFT15Digit(m.FCST_Contract__c)+'#'+LEFT15Digit(m.Contract_LineItem__c)+'#'+LEFT15Digit(m.FCST_Planning_Fiscal_Year__c)+'#'+LEFT15Digit(newVersion);
                        processKeys.add(key);
                        lstProcessModels.add(m);
                
            }
            map<string,FCST_Initial_Forecast__c> mapExistingModel = new map<string,FCST_Initial_Forecast__c>();
            for(FCST_Initial_Forecast__c m :[select Id,Model_Name__c,Account__c,Contract_LineItem__c,Fcst_Amount__c,FCST_Contract__c,FCST_Fiscal_Year_List__c,FCST_Planning_Fiscal_Year__c,Planning_Version__c,Risk_Factor__c from FCST_Initial_Forecast__c where Model_Name__c IN: processKeys]){
                mapExistingModel.put(m.Model_Name__c,m);
            }
            
            
       
            for(FCST_Initial_Forecast__c m :lstProcessModels){
                
                Id newVersion = mapVersionChangev2.get(m.Planning_Version__c).id;
                string Key = LEFT15Digit(m.FCST_Contract__c)+'#'+LEFT15Digit(m.Contract_LineItem__c)+'#'+LEFT15Digit(m.FCST_Planning_Fiscal_Year__c)+'#'+LEFT15Digit(newVersion);
                
                
                FCST_Initial_Forecast__c newModel;
                if(mapExistingModel.containsKey(key)){ newModel = mapExistingModel.get(key); newModel.Comments__c = 'Updated by copy from '+m.Planning_Version__r.Name; }
                else {
                    newModel = new FCST_Initial_Forecast__c ();
                    newModel.Comments__c = 'generated by copy from '+m.Planning_Version__r.Name;
                }
                    
                newModel.Account__c = m.Account__c;
                newModel.Contract_LineItem__c = m.Contract_LineItem__c;        
                newModel.Fcst_Amount__c = m.Fcst_Amount__c;
                newModel.FCST_Contract__c = m.FCST_Contract__c;
                newModel.FCST_Fiscal_Year_List__c = m.FCST_Fiscal_Year_List__c;
                newModel.FCST_Planning_Fiscal_Year__c= m.FCST_Planning_Fiscal_Year__c;   
                newModel.Planning_Version__c= newVersion;
                newModel.Risk_Factor__c= m.Risk_Factor__c;
                lstModels.add(newModel);
                                              
                  
            }
             if(lstModels != null && lstModels.size()>0){ 
             Database.UpsertResult[] srList = Database.upsert(lstModels, false);
             for(Integer i=0;i<srList.size();i++){
                  if(!srList.get(i).isSuccess()){
                      Database.Error dbErrors = srList.get(i).getErrors().get(0);
                     setFailedAccounts.add(lstModels.get(i).id); 
                  }
                 
              }
        }
        }
    }
    public string LEFT15Digit(string str){
        if(str <> null && str <> '' && str.length() > 15){
            str = str.substring(0,15);
        }
        return str;
    }

     global void finish(Database.BatchableContext BC){
     // sendMailToAdmin();
    }
    global void sendMailToAdmin(){
        List<Fcst_Batch_Status__c> lstAllAdmins = Fcst_Batch_Status__c.getAll().values();
        List<id> lstUserIds = new List<String>();
        for(Fcst_Batch_Status__c getRec:lstAllAdmins){
           lstUserIds.add(getRec.User_Id__c ); 
        }

        if(setFailedAccounts != null && setFailedAccounts.size()>0){
             String strBody = '';
                strBody = 'Please find attachement for Product model error records';
                String finalstr = 'Record Id \n';
                for(String getErrorIds:setFailedAccounts){
                    string recordString = '"'+getErrorIds+'"\n';
                    finalstr = finalstr +recordString; 
                }
                sendErrorTemplate(lstUserIds,strBody,finalstr);

        }
          
     }
     public void sendErrorTemplate(List<Id> lstUserIds, String strMessage,String finalstr){
       Messaging.SingleEmailMessage mail = new Messaging.SingleEmailMessage();
          
            mail.setToAddresses(lstUserIds);
            mail.subject = 'Product model Errro records | '+DateTime.now();
            mail.setPlainTextBody(strMessage);
                 Messaging.EmailFileAttachment attach = new Messaging.EmailFileAttachment();
                    attach.setBody(Blob.valueOf(finalstr));
                    attach.setFileName('ErrorFile.csv');
                    mail.setFileAttachments(new Messaging.EmailFileAttachment[]{attach});
        // Send the email you have created.
        Messaging.sendEmail(new Messaging.SingleEmailMessage[] { mail });

    }
}